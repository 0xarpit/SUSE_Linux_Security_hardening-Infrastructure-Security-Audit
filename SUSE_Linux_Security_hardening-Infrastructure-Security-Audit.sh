#!/bin/sh


#------------------------------------------------------------------------------------------------------------------------------
# SUSE_Security_Audit_Checks (Defect Retest)
#
#------------------------------------------------------------------------------------------------------------------------------
# Expected output: System Checks Completed
#------------------------------------------------------------------------------------------------------------------------------
# GUIDE
#------------------------------------------------------------------------------------------------------------------------------
# HOW TO USE
#
# The script should be executed as root with bash.
# eg:
#==>   bash SUSE_HBA.sh
#			or
# Make the file executable with root privileges: 
#
#==>	chmod a+x SUSE_HBA 
#
#Run it as below - 
#==>	./SUSE_HBA.sh
#
#------------------------------------------------------------------------------------------------------------------------------
# A series of checks are executed
# No modifications are performed
#
# Running this script should produce no result except the phrase
# "System Checks Completed".
# If there is any other output, then one or more warnings have been issued
#
# There will be an archive created once the script completes.
#------------------------------------------------------------------------------------------------------------------------------

echo "As part of APT 2018 - this HBA script will perform certain checks on this system"
echo "No changes will be made to system"
echo ""
echo ""
echo "Initializing script";
echo ""
sleep 1s
sleep 5s
echo ".........."

#------------------------------------------------------------------------------------------------------------------------------
# 1. 5606-1-SLES-04 Missing Operating System Security Patches
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Review of the current patch status-----------------------------------------------' >> Auditcheck.txt
showrev -p  >> Auditcheck.txt

echo '--------Patch Directory----------' >> Auditcheck.txt
cat /var/sadm/patch >> Auditcheck.txt
echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 2. 5606-1-SLES-05 Insecure Default Umask
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Current user info-----------------------------------------------' >> Auditcheck.txt
cat id  >> Auditcheck.txt

echo '--------Umask value----------' >> Auditcheck.txt
cat umask >> Auditcheck.txt
echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 3. 5606-1-SLES-06 Sudoers Permissive Rules
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Sudoers Permissive Rules-----------------------------------------------' >> Auditcheck.txt
cat /etc/sudoers  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 4. 5606-1-SLES-07 Unnecessary Packages Installed
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Review of the current patch status-----------------------------------------------' >> Auditcheck.txt


echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 5. 5606-1-SLES-08 Insecure Permissions On Sensitive Files
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------File Permission---------------------------' >> Auditcheck.txt
cat /etc/permissions.secure  >> Auditcheck.txt

echo '--------File Permission Value----' >> Auditcheck.txt
cat ls -la  >> Auditcheck.txt
echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 6. 5606-1-SLES-09 No Host-Based Firewall
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------No Host-Based Firewall-----------------------------------------------' >> Auditcheck.txt
cat  firewall-cmd --get-default-zone dmz  >> Auditcheck.txt

echo '--------No Host-Based Firewall----------' >> Auditcheck.txt
cat firewall-config >> Auditcheck.txt
echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 7. 5606-1-SLES-10 No Anti-Virus Solution Installed
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Review of the current patch status-----------------------------------------------' >> Auditcheck.txt
showrev -p  >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 8. 5606-1-SLES-11 No Centralised Logging and Analysis
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Logging and Analysis-----------------------------------------------' >> Auditcheck.txt
cat /var/log/  >> Auditcheck.txt

echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#------------------------------------------------------------------------------------------------------------------------------
# 9. 5606-1-SLES-12 Unowned Files 
#------------------------------------------------------------------------------------------------------------------------------

echo '----------------------------------------Review of the current patch status-----------------------------------------------' >> Auditcheck.txt
cat find / -path /proc -prune -o -nouser -o -nogroup  >> Auditcheck.txt

echo '--------Patch Directory----------' >> Auditcheck.txt
cat /var/sadm/patch >> Auditcheck.txt
echo '--------------------------------------------------------------------------------------------------------' >> Auditcheck.txt

echo '###############################################################################################################################################' >> Auditcheck.txt

#-------------------------------------------------------------------------------------------------------------
# Creating Archive
zip Audit_check Auditcheck.txt &> /dev/null;
sleep 5
#--------------------------------------------------------------------------------------------------------------
# DONE
#--------------------------------------------------------------------------------------------------------------

echo "System Checks Completed"
